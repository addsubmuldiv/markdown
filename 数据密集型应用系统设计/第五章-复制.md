# 复制

## 领导者与追随者

数据库分成主库和从库，主库只有一个，也叫领导者，从库可以有多个，就是主库的副本，主库上的所有数据，在从库上都有一个备份，从库也成为追随者、热备

- ==写入==都在领导者，然后在追随者（副本）上复制一份，

- ==读取==从领导者还是追随者读都一样![img](https://gitee.com/Lighters_c/picgo-bed/raw/master/6aXNsbg8Drzw9oQ.png)



### 同步复制还是异步

![img](https://gitee.com/Lighters_c/picgo-bed/raw/master/1GFuMoVds4cQhBr.png)

#### 同步

 - 优势
   	- 数据一致
- 劣势
  - 延迟高，鲁棒性差，一个从库挂了就没法写了

#### 半同步

使用一个从库和主库完全同步，其他的异步，如果同步从库挂掉了，就把一个异步从库变成同步

#### 异步

 ==通常==情况下，基于领导者的复制都配置为==完全异步==（不过具有最终一致性）。

- 好处，不管从库，主库好着就怎样都能写入
- 坏处，主库挂掉了，没备份的数据就没了，弱化了持久



### 新从库

设置新从库，一般是对主库拍个快照，然后把快照复制过来，这样就不用担心主库频繁变化，快照复制完了再看新的数据



### 节点宕机怎么处理



### 如何复制

- 基于语句的复制，直接把主库执行的SQL语句给从库也执行一遍，但是对于NOW()这种函数就会出问题，必须是确定性的数据才能这么做

- 基于WAL日志的复制，日志会记录哪个字节变化，基本上就是完全一样了，但是如果存储格式变化，比如数据库版本不一样可能就不行，存在ABI不兼容问题

- 基于逻辑日志的复制（基于行），这种日志和物理结构解耦，可以在不同版本的数据库之间迁移（但是逻辑日志数据量大）

- 基于触发器，触发器允许您注册在数据库系统中发生数据更改（写入事务）时自动执行的自定义应用程序代码。触发器有机会将更改记录到一个单独的表中，使用外部程序读取这个表，再加上任何业务逻辑处理，会后将数据变更复制到另一个系统去。

  



## 复制延迟问题

- 读己之写（写后读）写入以后立即读取，可能看不到自己的数据，不仅在于一个设备，跨设备也存在这个问题，手机写入了，电脑看不到

- 单调读，可能遇到先向数据较新的从库读了，刷新以后又把请求转发到了旧的从库，导致数据不一致
- 一致前缀读，如果一系列写入按某个顺序发生，那么任何人读取这些写入时，也会看见它们以同样的顺序出现。一般是在分区、分片数据库里会出现，因为不存在全局写入顺序，可能会看到数据库的某些部分处于较旧的状态，而某些处于较新的状态。==所以需要确保任何因果相关的写入都写入相同的分区。==

- 解决复制延迟的一个好方法就是使用==事务==，单点事务已经用了很久，但是分布式环境事务就很复杂

## 多主复制

### 应用场景

- 多数据中心，感觉有点类似边缘计算，就是离用户更近，延迟更低，有些数据库默认情况下支持多主配置，但使用外部工具实现也很常见
  - MySQL的Tungsten Replicator
  - 用于PostgreSQL的BDR
  - 用于Oracle的GoldenGate
- 离线操作的客户端，本地设备和服务器各自有一个主库
  - CouchDB就是为这种操作模式而设计的
- 协同编辑，实时协作编辑应用程序允许多个人同时编辑文档。
  - 通常不会将协作式编辑视为数据库复制问题，但与前面提到的离线编辑用例有许多相似之处。当一个用户编辑文档时，所做的更改将立即应用到其本地副本（Web浏览器或客户端应用程序中的文档状态），并异步复制到服务器和编辑同一文档的任何其他用户。
  -  如果要保证不会发生编辑冲突，则应用程序必须先取得文档的锁定，然后用户才能对其进行编辑。

### 处理写入冲突

两个人对同一个数据进行了修改，分别提交到了自己这边的主库，就会冲突

处理写冲突的解决方案

- 同步与异步冲突检测
  - 这种在多主节点很不好使，单主节点还行

- 避免冲突
  - 让应用层保证对特定记录的写请求都通过同一个主节点
- 收敛于一致状态，不管怎样，最后所有副本一定一样
  - 每个写入一个ID, ID最大的写入，其他丢弃，ID可以是时间戳、UUID，会丢失数据
  - 写入副本的时候按顺序，类似于解决死锁的时候请求资源按顺序，但是也会丢失数据
  - 写入的值直接拼在一起
  - 保存冲突日志，放在应用层逻辑解决
- 自定义冲突解决逻辑
  - 应用层解决

- 自动冲突解决
  - 无冲突的复制数据类型，一些专门用于复制的数据结构
  - 可合并的持久数据结构，跟踪变更历史，类似git



## 无主节点复制

Dynamo、Riak、Cassandra、Voldemort

有些直接把写请求发送到多副本，有些由一个协调者节点代表客户端进行写入，但是协调者不负责写入顺序的维护

### 节点失效时写入

三个副本，俩正常一个失效，写的时候不管失效的，正常的全写，读的时候全读，靠版本号确定哪个值更新

对于失效节点的修复，可以采用

- 读修复，读出来发现有个不对，就更新它
- 反熵过程，有些数据库有一个后台进程不断查找副本之间的数据差异，来维持同步



### 几个副本写了算成功

法定票数读、写，![image-20211016190459107](https://gitee.com/Lighters_c/picgo-bed/raw/master/image-20211016190459107.png)

